@page "/createcomp"
@using SkyVoteTime.Client.API;
@using SkyVoteTime.Shared
@using System.Text.Json;
@inject HttpClient Http
@inject NavigationManager NavigationManager
@inject IJSRuntime JsRuntime

@inject TheMovieDBApi movieApi;

<h1 class="title" style="text-align:center; margin-top:100px">CreateCompetition</h1>



<div class="container rounded-3 fundo justify-content-center" style="width:55%; margin-top:70px;">

    <div class="container justify-content-center" style="width:80%">

        <form>
            <div class="texto" style="margin-top:50px;">
                <label for="name">Name: </label>
                <input type="name" class="form-control input-lg" @bind="@competition.Name" id="exampleName" aria-describedby="NameHelp" placeholder="Enter the name of the Competition">
            </div>
            <br>
            <div class="texto">
                <label for="description">Description: </label>
                <input type="description" @bind="@competition.Description" class="form-control input-lg" id="exampleDescription" placeholder="Enter the description for the Competition">
            </div>

        </form>

        <br>
        <br>

        <div class="dropdown">
            <button class="btn btn-secondary btn-lg dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                Competition Type
            </button>
            <div class="dropdown-menu col-xs-12" aria-labelledby="dropdownMenuButton">
                <a class="dropdown-item" href="#">Filme</a>
                <a class="dropdown-item" href="#">Ator</a>
                <a class="dropdown-item" href="#">Diretor</a>
            </div>
        </div>



        <br />
        <br />
        <br />
        
        <p class="texto">Category</p>
        <br />

        <div class=" container check justify-content-center">
            <div class="col-sm-1"></div>
            <div class="col-sm-2">
                <div class="form-check">
                    <label class="form-check-label">
                        <input type="checkbox" @onchange="@(e => OnCategoryChecked("Action", e))" class="form-check-input" value="">
                        <label for="cat" class="cat"> Action</label>
                    </label>
                </div>
                <br />       
                <div class="form-check">
                    <label class="form-check-label">
                        <input type="checkbox" @onchange="@(e => OnCategoryChecked("Drama", e))" class="form-check-input" value="">
                        <label for="cat" class="cat"> Drama</label>
                    </label>
                </div>
                <br />
                <div class="form-check">
                    <label class="form-check-label">
                        <input type="checkbox" @onchange="@(e => OnCategoryChecked("Romance", e))" class="form-check-input" value="">
                        <label for="cat" class="cat"> Romance</label>
                    </label>
                </div>
                <br />
                <br />
                <br />
            </div>
            <div class="col-sm-2">
                <div class="form-check">
                    <label class="form-check-label">
                        <input type="checkbox" @onchange="@(e => OnCategoryChecked("Documentary", e))" class="form-check-input" value="">
                        <label for="cat" class="cat"> Documentary</label>
                    </label>
                </div>
                <br />
                <div class="form-check">
                    <label class="form-check-label">
                        <input type="checkbox" @onchange="@(e => OnCategoryChecked("Suspense", e))" class="form-check-input" value="">
                        <label for="cat" class="cat"> Suspense</label>
                    </label>
                </div>
                <br />
                <div class="form-check">
                    <label class="form-check-label">
                        <input type="checkbox" @onchange="@(e => OnCategoryChecked("Horror", e))" class="form-check-input" value="">
                        <label for="cat" class="cat"> Horror</label>
                    </label>
                </div>
                <br />
                <br />
                <br />
            </div>
            <div class="col-sm-3">
                <div class="form-check">
                    <label class="form-check-label">
                        <input type="checkbox" @onchange="@(e => OnCategoryChecked("Science fiction", e))" class="form-check-input" value="">
                        <label for="cat" class="cat"> Science fiction</label>
                    </label>
                </div>
                <br />
                <div class="form-check" >
                    <label class="form-check-label">
                        <input type="checkbox" @onchange="@(e => OnCategoryChecked("Comedy", e))" class="form-check-input" value="">
                        <label for="cat" class="cat"> Comedy</label>
                    </label>
                </div>
                <br />
                <div class="form-check">
                    <label class="form-check-label">
                        <input type="checkbox" @onchange="@(e => OnCategoryChecked("Adventure", e))" class="form-check-input" value="">
                        <label for="cat" class="cat"> Adventure</label>
                    </label>
                </div>
                <br />
                <br />
                <br />
            </div>
        </div>

        <!--Search Movie-->
        <div class="form-group row">
            <div class="col-xl-11">
                <input class="form-control" type="text" @bind-value="@search" @bind-value:event="oninput" @onkeyup="KeyHandler" placeholder="Search movie" />
            </div>
            <div class="col-xs-2">
                <input class="form-control" id="searchButton" type="submit" @onclick="GetPosters" value="Go" />
            </div>
            <div>
            </div>
        </div>

        <div style="display:flex; flex-wrap: wrap; overflow-y: auto;">
            @if (movieList != null)
            {
                @foreach (var i in @movieList.results)
                {
                    <div class="poster">
                        <div class="flip-card_i" style="max-width: 150px; max-height: 250px;">
                            <div class="flip-card-inner_i">
                                <div class="flip-card-front_i">
                                    <img src="https://image.tmdb.org/t/p/w342/@i.poster_path" alt="Avatar" style="width:250px;height:360px;">
                                    <div class="form-check form-check-inline">
                                        <label class="form-check-label" for="inlineCheckbox1">1</label>
                                        <div class="col-xs-2">
                                            <input class="form-control" id="choose" type="submit" @bind-value="@i.id" @onclick="@(e => GetMovie(@i.id))" />
                                        </div>
                                    </div>
                                </div>

                            </div>
                            <div class="flim">
                                <b>@i.title</b><br>IMDb - 8.8
                            </div>
                        </div>
                    </div>
                }
            }
        </div>


        <div class="form-check form-switch switch">
            <input class="form-check-input" type="checkbox" role="switch" id="flexSwitchCheckDefault">
            <label class="cat2" for="flexSwitchCheckDefault">Public</label>
        </div>
        <br>
        <br />
        <br />

        <div class="col-sm-3"></div>
        <div class="col-sm-2">
            <button type="button" @onclick="@Cancel" value="Cancel" class="btn btn-light btn-lg">Cancel</button>
        </div>
        <div class="col-sm-2"></div>
        <div class="col-sm-1">
            <button type="button" @onclick="@Save" value="Submit" class="btn btn-warning btn-lg">Submit</button>
        </div>
        <br>
        <br />
        <br />

    </div>
    <br>
    <br />
</div>
<br>
<br />
<br />


@code {
    Competition competition = new Competition();

    private List<string> selectedCategories = new List<string>();
    private List<string> selectedMovies = new List<string>();

    private string search { get; set; }
    private string moviePath;
    private MovieList movieList;

    //== Movie Search ==//
    private async Task GetPosters()
    {

        movieList = await movieApi.searchMovieDetails(search);
    } // MovieSearch()


    private async Task KeyHandler(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await GetPosters();
        }
    }

    public async Task GetMovie(int id)
    {
        OnMovieButtonClick(id.ToString());
        await movieApi.GrabMovieAsync(id);
} // GetMovie()

private void OnCategoryChecked(string categoryName, ChangeEventArgs e)
{   
    var isChecked = (bool)e.Value;

    if (isChecked)
    {
        selectedCategories.Add(categoryName);
    }
    else
    {
        selectedCategories.Remove(categoryName);
    }
}

private void OnMovieButtonClick(string movieId)
{
    if (!selectedMovies.Contains(movieId))
    {
        selectedMovies.Add(movieId);
    }
}

protected override async Task OnInitializedAsync()
{
}
protected async Task Save()
{
    competition.CategoriesJson = JsonSerializer.Serialize(selectedCategories);
    Console.WriteLine(competition.CategoriesJson);

    competition.MoviesJson = JsonSerializer.Serialize(selectedMovies);
    Console.WriteLine(competition.MoviesJson);

    var response = await Http.PostAsJsonAsync("api/Competition", @competition);
    Competition competitionResponse = await response.Content.ReadFromJsonAsync<Competition>();
        if (competitionResponse?.Id > 0)
        {
            await JsRuntime.InvokeVoidAsync("alert", "Saved Successfully!");
            NavigationManager.NavigateTo("");
        }
    }

    void Cancel()
    {
        NavigationManager.NavigateTo("");
    }


}